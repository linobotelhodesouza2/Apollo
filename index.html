<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Formulário de Produtos</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <script src="https://www.gstatic.com/firebasejs/8.6.2/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.2/firebase-database.js"></script>
    <style>
        .dropdown-menu {
            max-height: 300px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div class="container mt-5">
        <h1 class="text-center">Cadastro de Produtos</h1>
        <form id="produtoForm">
            <div class="form-group">
                <label for="produto">Produto:</label>
                <input type="text" class="form-control" id="produto" required>
            </div>
            <div class="form-group">
                <label for="perimetro">Perímetro:</label>
                <input type="text" class="form-control" id="perimetro" required>
            </div>
            <div class="form-group">
                <label for="corte">Corte:</label>
                <input type="text" class="form-control" id="corte" required>
            </div>
            <div class="form-group">
                <label for="velocidade">Velocidade:</label>
                <input type="text" class="form-control" id="velocidade" required>
            </div>
            <div class="form-group">
                <label for="chagrim">Chagrim:</label>
                <input type="text" class="form-control" id="chagrim" required>
            </div>
            <div class="form-group">
                <label for="repeticao">Repetição:</label>
                <input type="text" class="form-control" id="repeticao" required>
            </div>
            <div class="form-group">
                <label for="comentario">Comentário:</label>
                <textarea class="form-control" id="comentario"></textarea>
            </div>
            <button type="submit" class="btn btn-primary">Salvar</button>
        </form>

        <div id="successMessage" class="alert alert-success mt-3" style="display:none;">
            Produto salvo com sucesso!
        </div>

        <h2 class="mt-5">Produtos Salvos</h2>
        <div class="dropdown">
            <button class="btn btn-secondary dropdown-toggle" type="button" id="dropdownMenuButton" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                Selecione um Produto
            </button>
            <div class="dropdown-menu" id="produtosSalvos" aria-labelledby="dropdownMenuButton">
            </div>
        </div>

        <div id="produtoDetalhes" style="display:none;" class="mt-5">
            <h3>Detalhes do Produto</h3>
            <p><strong>Nome:</strong> <span id="detNome"></span></p>
            <p><strong>Perímetro:</strong> <span id="detPerimetro"></span></p>
            <p><strong>Corte:</strong> <input type="text" id="detCorte"></p>
            <p><strong>Velocidade:</strong> <input type="text" id="detVelocidade"></p>
            <p><strong>Chagrim:</strong> <span id="detChagrim"></span></p>
            <p><strong>Repetição:</strong> <span id="detRepeticao"></span></p>
            <button id="salvarEdicao" class="btn btn-success">Salvar Edição</button>
            <button id="excluirProduto" class="btn btn-danger">Excluir Produto</button>
            <h4>Comentários</h4>
            <div id="comentariosList"></div>
            <form id="novoComentarioForm">
                <div class="form-group">
                    <label for="novoComentario">Novo Comentário:</label>
                    <input type="text" class="form-control" id="novoComentario" required>
                </div>
                <button type="submit" class="btn btn-primary">Adicionar Comentário</button>
            </form>
        </div>
    </div>

    <script>
        // Configuração do Firebase
        var firebaseConfig = {
            apiKey: "AIzaSyB0DfSwB68tf7FagfGSLyOszQRduYoGiak",
            authDomain: "lino-29b0b.firebaseapp.com",
            databaseURL: "https://lino-29b0b-default-rtdb.firebaseio.com",
            projectId: "lino-29b0b",
            storageBucket: "lino-29b0b.appspot.com",
            messagingSenderId: "731949645073",
            appId: "1:731949645073:web:4eaf9011174f08473ee0b0"
        };

        // Inicialização do Firebase
        firebase.initializeApp(firebaseConfig);
        var db = firebase.database();

        // Evento de envio do formulário
        document.getElementById('produtoForm').addEventListener('submit', function (e) {
            e.preventDefault();

            var produto = {
                nome: document.getElementById('produto').value,
                perimetro: document.getElementById('perimetro').value,
                corte: document.getElementById('corte').value,
                velocidade: document.getElementById('velocidade').value,
                chagrim: document.getElementById('chagrim').value,
                repeticao: document.getElementById('repeticao').value,
                comentario: document.getElementById('comentario').value,
                comentarios: [] // Inicializa a lista de comentários
            };

            // Salvando produto no Firebase
            db.ref('produtos').push(produto).then(() => {
                mostrarMensagemSucesso();
                atualizarProdutosSalvos();
                document.getElementById('produtoForm').reset();
            }).catch(error => {
                console.error('Erro ao salvar produto:', error);
            });
        });

        // Função para exibir mensagem de sucesso
        function mostrarMensagemSucesso() {
            const successMessage = document.getElementById('successMessage');
            successMessage.style.display = 'block';
            setTimeout(() => {
                successMessage.style.display = 'none';
            }, 3000);
        }

        // Função para atualizar a lista de produtos salvos no dropdown
        function atualizarProdutosSalvos() {
            const produtosSalvosList = document.getElementById('produtosSalvos');
            produtosSalvosList.innerHTML = '';

            db.ref('produtos').once('value').then(snapshot => {
                snapshot.forEach(childSnapshot => {
                    const produto = childSnapshot.val();
                    const li = document.createElement('a');
                    li.className = 'dropdown-item';
                    li.textContent = produto.nome;
                    li.href = '#';
                    li.onclick = () => mostrarDetalhesProduto(childSnapshot.key, produto);
                    produtosSalvosList.appendChild(li);
                });
            }).catch(error => {
                console.error('Erro ao atualizar produtos salvos:', error);
            });
        }

        // Função para mostrar detalhes do produto selecionado
        function mostrarDetalhesProduto(key, produto) {
            produtoAtual = produto;
            produtoIndex = key;
            document.getElementById('detNome').textContent = produto.nome;
            document.getElementById('detPerimetro').textContent = produto.perimetro;
            document.getElementById('detCorte').value = produto.corte;
            document.getElementById('detVelocidade').value = produto.velocidade;
            document.getElementById('detChagrim').textContent = produto.chagrim;
            document.getElementById('detRepeticao').textContent = produto.repeticao;
            document.getElementById('produtoDetalhes').style.display = 'block';
            atualizarComentarios(produto.comentarios || []);
        }

        // Função para atualizar a lista de comentários
        function atualizarComentarios(comentarios) {
            const comentariosList = document.getElementById('comentariosList');
            comentariosList.innerHTML = '';

            if (comentarios.length > 0) {
                comentarios.forEach((comentario, index) => {
                    const p = document.createElement('p');
                    p.textContent = `${index + 1}. ${comentario}`;
                    comentariosList.appendChild(p);
                });
            } else {
                comentariosList.innerHTML = '<p>Nenhum comentário encontrado.</p>';
            }
        }

        // Evento de envio do formulário de comentário
        document.getElementById('novoComentarioForm').addEventListener('submit', function (e) {
            e.preventDefault();

            if (produtoAtual && produtoIndex) {
                const novoComentario = document.getElementById('novoComentario').value;
                produtoAtual.comentarios = produtoAtual.comentarios || [];
                produtoAtual.comentarios.push(novoComentario);

                // Atualiza o Firebase com o novo comentário
                db.ref('produtos/' + produtoIndex).update({
                    comentarios: produtoAtual.comentarios
                }).then(() => {
                    atualizarComentarios(produtoAtual.comentarios);
                    document.getElementById('novoComentario').value = '';
                }).catch(error => {
                    console.error('Erro ao adicionar comentário:', error);
                });
            }
        });

        // Evento de salvar edição do produto
        document.getElementById('salvarEdicao').addEventListener('click', function () {
            if (produtoIndex) {
                const produtoAtualizado = {
                    ...produtoAtual,
                    corte: document.getElementById('detCorte').value,
                    velocidade: document.getElementById('detVelocidade').value
                };

                db.ref('produtos/' + produtoIndex).update(produtoAtualizado).then(() => {
                    mostrarMensagemSucesso();
                }).catch(error => {
                    console.error('Erro ao atualizar produto:', error);
                });
            }
        });

        // Evento de excluir produto
        document.getElementById('excluirProduto').addEventListener('click', function () {
            if (produtoIndex) {
                db.ref('produtos/' + produtoIndex).remove().then(() => {
                    produtoAtual = null;
                    produtoIndex = null;
                    document.getElementById('produtoDetalhes').style.display = 'none';
                    atualizarProdutosSalvos();
                    mostrarMensagemSucesso();
                }).catch(error => {
                    console.error('Erro ao excluir produto:', error);
                });
            }
        });

        // Inicializa a lista de produtos salvos
        atualizarProdutosSalvos();
    </script>
</body>
</html>
